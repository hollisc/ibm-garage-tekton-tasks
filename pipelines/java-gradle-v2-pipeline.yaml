apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: ibm-java-gradle-v2
  annotations:
    app.openshift.io/runtime: openjdk
    app.openshift.io/builder: gradle
spec:
  params:
  - description: The url for the git repository
    name: git-url
  - default: master
    description: The git revision (branch, tag, or sha) that should be built
    name: git-revision
  - default: "true"
    description: Enable the pipeline to scan the image for vulnerabilities
    name: scan-image
  tasks:
  - name: setup
    params:
    - name: git-url
      value: $(params.git-url)
    - name: git-revision
      value: $(params.git-revision)
    - name: scan-image
      value: $(params.scan-image)
    taskRef:
      kind: Task
      name: ibm-setup-ace-bar
  - name: test
    params:
    - name: git-url
      value: $(tasks.setup.results.git-url)
    - name: git-revision
      value: $(tasks.setup.results.git-revision)
    - name: source-dir
      value: $(tasks.setup.results.source-dir)
    - name: app-name
      value: $(tasks.setup.results.app-name)
    runAfter:
    - setup
    taskRef:
      kind: Task
      name: ibm-java-gradle-test
  - name: build
    params:
    - name: git-url
      value: $(tasks.setup.results.git-url)
    - name: git-revision
      value: $(tasks.setup.results.git-revision)
    - name: source-dir
      value: $(tasks.setup.results.source-dir)
    - name: image-server
      value: $(tasks.setup.results.image-server)
    - name: image-namespace
      value: $(tasks.setup.results.image-namespace)
    - name: image-repository
      value: $(tasks.setup.results.image-repository)
    - name: image-tag
      value: $(tasks.setup.results.image-tag)
    runAfter:
    - test
    taskRef:
      kind: Task
      name: ibm-build-tag-push
  - name: deploy
    params:
    - name: git-url
      value: $(tasks.setup.results.git-url)
    - name: git-revision
      value: $(tasks.setup.results.git-revision)
    - name: source-dir
      value: $(tasks.setup.results.source-dir)
    - name: image-server
      value: $(tasks.setup.results.image-server)
    - name: image-namespace
      value: $(tasks.setup.results.image-namespace)
    - name: image-repository
      value: $(tasks.setup.results.image-repository)
    - name: image-tag
      value: $(tasks.setup.results.image-tag)
    - name: app-namespace
      value: $(tasks.setup.results.app-namespace)
    - name: app-name
      value: $(tasks.setup.results.app-name)
    - name: deploy-ingress-type
      value: $(tasks.setup.results.deploy-ingress-type)
    - name: tools-image
      value: $(tasks.setup.results.tools-image)
    runAfter:
    - build
    taskRef:
      kind: Task
      name: ibm-deploy
  - name: health
    params:
    - name: app-namespace
      value: $(tasks.setup.results.app-namespace)
    - name: app-name
      value: $(tasks.setup.results.app-name)
    - name: deploy-ingress-type
      value: $(tasks.setup.results.deploy-ingress-type)
    - name: health-protocol
      value: $(tasks.setup.results.health-protocol)
    - name: health-endpoint
      value: $(tasks.setup.results.health-endpoint)
    - name: health-url
      value: $(tasks.setup.results.health-url)
    - name: health-curl
      value: $(tasks.setup.results.health-curl)
    - name: tools-image
      value: $(tasks.setup.results.tools-image)
    - name: api-basepath
      value: $(tasks.setup.results.api-basepath)
    runAfter:
    - deploy
    taskRef:
      kind: Task
      name: ibm-health-check-basepath
  - name: pact-verify
    params:
    - name: git-url
      value: $(tasks.setup.results.git-url)
    - name: git-revision
      value: $(tasks.setup.results.git-revision)
    - name: source-dir
      value: $(tasks.setup.results.source-dir)
    - name: service-host
      value: $(tasks.setup.results.app-name)
    - name: service-port
      value: $(tasks.deploy.results.service-port)
    runAfter:
    - health
    taskRef:
      kind: Task
      name: ibm-gradle-pact-verify
  - name: tag-release
    params:
    - name: git-url
      value: $(tasks.setup.results.git-url)
    - name: git-revision
      value: $(tasks.setup.results.git-revision)
    - name: source-dir
      value: $(tasks.setup.results.source-dir)
    - name: js-image
      value: $(tasks.setup.results.js-image)
    runAfter:
    - pact-verify
    taskRef:
      kind: Task
      name: ibm-tag-release
  - name: img-release
    params:
    - name: image-from
      value: $(tasks.setup.results.image-url)
    - name: image-to
      value: $(tasks.setup.results.image-release):$(tasks.tag-release.results.tag)
    runAfter:
    - tag-release
    taskRef:
      kind: Task
      name: ibm-img-release
  - name: img-scan
    params:
    - name: image-url
      value: $(tasks.img-release.results.image-url)
    - name: scan-trivy
      value: $(tasks.setup.results.scan-trivy)
    - name: scan-ibm
      value: $(tasks.setup.results.scan-ibm)
    runAfter:
    - img-release
    taskRef:
      kind: Task
      name: ibm-img-scan
  - name: helm-release
    params:
    - name: git-url
      value: $(tasks.setup.results.git-url)
    - name: git-revision
      value: $(tasks.setup.results.git-revision)
    - name: source-dir
      value: $(tasks.setup.results.source-dir)
    - name: image-url
      value: $(tasks.img-release.results.image-url)
    - name: app-name
      value: $(tasks.setup.results.app-name)
    - name: deploy-ingress-type
      value: $(tasks.setup.results.deploy-ingress-type)
    - name: tools-image
      value: $(tasks.setup.results.tools-image)
    runAfter:
    - img-scan
    taskRef:
      kind: Task
      name: ibm-helm-release
  - name: gitops
    params:
    - name: app-name
      value: $(tasks.setup.results.app-name)
    - name: version
      value: $(tasks.tag-release.results.tag)
    - name: helm-url
      value: $(tasks.helm-release.results.helm-url)
    - name: tools-image
      value: $(tasks.setup.results.tools-image)
    runAfter:
    - helm-release
    taskRef:
      kind: Task
      name: ibm-gitops
